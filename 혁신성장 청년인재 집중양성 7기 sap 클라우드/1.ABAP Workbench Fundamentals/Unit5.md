# Unit5 The System Core

## 목표

* ### 시스템 상태 정보에 액세스

* ### AS ABAP 시스템의 프로세스 구분

* ### AS ABAP 에서의 요청 처리

* ### AS ABAP 에서의 트랜잭션 처리

* ### 인쇄요청처리

* ### 백그라운드 작업 일정 계획

* ### 게이트웨이를 사용한 통신

* ### 웹요청 처리



****

****



## Lesson1. Explaining AS ABAP and AS java System Architecture

****

### 개요

이 소단원에서는 SAP NetWeaver Application Server(AS)의 서로 다른 유형인 AS ABAP(Advanced Buisiness Application Programming), AS Java, AS ABAP+Java의 아키텍처에 대해 설명한다.

### 목표

* 시스템 상태 정보에 액세스

****





![figure33](./img/figure33.png)

* ### AS ABAP 시스템

  이 유형의 AS는 ABAP 기반의 어플리케이션을 개발하고 사용할 수 있는 전체 인프라를 제공한다.

* ### AS Java 시스템

  이 유형의 AS는 J2EE 기반의 어플리케이션을 개발하고 사용할 수 있는 전체 인프라를 제공한다.

* ### AS ABAP + Java 시스템

  이 유형의 AS 는 ABAP 기반 어플리케이션과 J2EE 기반 어플리케이션을 개발하고 사용할 수 있는 전체 인프라를 제공한다.

  이 유형의 시스템은 SAP Process Integration 또는 SAP Solution Manager 등의 솔루션에서 명시적으로 요구하는 경우에만 설치한다.

#### SAP NetWeaver AS의 중요한 특징중 하나는 데이터베이스의 ABAP 스키마는 ABAP 테이블, 프로그램, 어플리케이션을 저장하고 Java 스키마는 Java 데이터를 저장한다는 점이다. 

#### SAP NetWeaver AS ABAP의 경우 7.0X와 상위 릴리스 간에 아키텍처 면에서 변경된 점이 없다.

#### 단. 7.1 부터는 Central Instance(CI) '중앙 인스턴스' 라는 용어가 Primary Appi. Server(PAS) '주 어플리케이션 서버'로 Dialog Instance(DI) '다이얼로그 인스턴스' 가 Addtional Application Server '추가 어플리케이션 서버' 로 바뀌었다.

#### 또한 ABAP MS와 ABAP ES가 Central Services 에 구분된다.



****



* ## Message Server 

  * AS ABAP 의 내부통신을 처리하는 중앙 메시지 서비스 담당
    * **EX )** 업데이트 시작, 잠금 요청 및 제거, 백그라운드 요청 실행
  * 시스템에서 현재 사용가능한 인스턴스에 대한 정보를 제고
  * 어플리케이션 서버에 있는 ABAP 디스패처 사이의 프로세스간 통신을 가능하게 한다.
    * 메시지 서버는 SAP 시스템당 한번만 설치된다.
  * 사용자가 SAP GUI for Windows 또는 SAP GUI for Java에서 로그온 그룹을 사용하여 AS ABAP에 로그온 할 때 사용자로 인한 부하를 여유 인스턴스에 분배



여러개의 서버로 운용 될때 ABAP Dispatcher를 사용하며

7.1 이상부터 를 사용한다. 

 가 Central Services 로 분리 된다.	







****

****







## Lesson2. Identifying the processes of an AS ABAP System

****

### 개요

이 소단원에서는 AS ABAP 시스템에서 실행되는 프로세스를 개적으로 설명한다.

### 목표

* AS ABAP 시스템의 프로세스 구분

****



![ASABAPProcesses](./img/ASABAPProcesses.png)

* ### ABAP Dispatcher의 역할:

  * 요청을 작업 프로세스에 배분한다.

* ### The Message Server (MS)

  * AS ABAP 내의 분산된 디스패터들 사이의 통신을 처리한다.
  * 이는 여러개의 어플리케이션 서버를 원할하게 동시에 운영할 수 있도록 해준다.
  * **MS는 시스템당 한번만 구성된다.**

* ### The Gateway (GW)

  * SAP 시스템간 통신,  또는 SAP 시스템과 외부 어플리케이션 싯템간의 통신을 가능하게 한다.
  * 각각의 별도로 구성되어있는 SAP 시스템 또는 non-SAP 시스템을 연결해주는 역할을 한다.
  * **디스패처마다 하나의 GW 리더가 있다.**

* ### The Internet Communication Manager (ICM)

  * HTTP등의 웹 프로토콜을 사용하여 SAP 시스템과의 통신을 가능하게 한다.
  * ICM 은 클라이언트로 부터 요청을 받아 이를 SAP 시스템에 전달하여 처리하게 한다.
  * ABAP + Java 시스템에서는 요청이 AS ABAP용인지 AS Java용인지르르 판단하여 그에 맞게 전달한다.
  * 또한 SAP 시스템에서 웹 서버로 HTTP 요청을 전달하고 다시 그 응답을 웹서버에서 받아 SAP 시스템에 보낼 수도 있다.
  * **어플리케이션 서버당 ICM 프로세스를 하나만 구성할 수 있다. (소프트웨어 기준 관점)**



* ### Work Process

  * #### Dialog DWP

    * 사용자의 요청에 의해 dialog 스탭을 수행
    * 쉽게 말해 ABAP 의 구문이 한줄한줄 씩 순차적으로 진행되어 가는 것

    * **ABAP Dispatcher 별로 최소 두개** 이상 있어야 한다.
    * **가장 많이 사용**

  * #### Background BWP

    * 사용자와 상호작용 없이 실행되는 프로그램을 철히한다.
    * 지정한 스케줄 마다 시스템을 실행시켜준다.
    * 하나의 작업이 너무 오래 걸릴때도 사용
    * **ABAP dispatcher 별로 최소 하나** 존재해야한다.
    * **ABAP dispatcher 별로 두개 이상**  존재하는 것이 이상적이다.
      * 기본적으로 SAP 시스템의 일반적인 작업을 수행하기에는 하나의 백그라운드 프로세스로 충분
      * 하지만 **업그레이드나 ABAP 전송 요청의 임포트**와 같은 작업을 위해서는 **두번째 백그라운드 작업 프로세스 필요**

  * #### Lock management EWP

    * 공유 메모리의 잠금테이블을 관리
      * 여러 유저에 의해 사용되다 보니 여러 유저에 의해 데이터가 동시에 수정되는 상황이 발생
      * 따라서 특정 유저가 데이터를 수정중일때 다른 유저가 수정할 수 없게 설정을 해준다.
      * ABAP 런타임 환경에서의 논리적 데이터베이스 잠금이 기록된다.
    * 이것이  **인큐 워크 프로세스**이다.
    * **SAP 시스템마다 하나만 필요**
      * 각각의 서버 마다 있으면 문제 발생

  * #### Update VWP

    * 업데이트 요청을 처리한다. 
    * **SAP 시스템당 최소 하나** 존재해야한다.
    * **ABAP dispatcher 별로 최소 둘 이상** 구성 가능하다.

  * #### Spool S

    * 프린터를 통해 출력할때 사용
    * **SAP 시스템당 최소 하나** 존재해야한다.
    * **ABAP dispatcher 별로 최소 둘 이상** 구성 가능하다.





****

****







## Lesson3. Processing User Requests in AS ABAP

****

### 개요

AS ABAP 에서 사용자 요청이 어떻게 처리되는지 설명한다. 트랜잭션, 잠금, 업데이트 처리 개념에 대해서도 설명한다.

### 목표

* AS ABAP에서의 요청 처리
* AS ABAP에서의 트랜잭션 처리

****

* ## SAP GUI 에서 들어오는 사용자 요청 처리

  ![request](./img/request.png)

  사용자는 SAP 시스템에 SAP GUI 또는 웹 클라이언트(브라우저)를 통해 로그온 할 수 있다.

  SAP GUI를 통해 로그온 하면 사용자 요청이 ABAP 런타임 환경에 의해 처리된다.

  브라우저를 통해 로그온 하면 사용자 요청이 그 성격에 따라 ABAP 런타임 환경에 의해 처리되기도 하고 Java 런타임 환경에의해 처리되기도 한다.

  사용자가 MS를 통해 로그온 하거나 ABAP 디스패쳐를 통해 직접 로그온 하고 나면 사용자 요청이 작업 프로세스에 의해 처리된다.

  위 그림에서 보는 것과 같이, AS ABAP 에서 사용자 요청을 처리할 때는 세개의 계층 ***Presentation 화면 Layer, Application어플리케이션 Level , Database데이터베이스 level***에 걸쳐 여러 프로세스가 관련된다.

   사용자가 화면에 입력한 정보는 SAP GUI에 접수되어 내부 포맷으로 변환된 다음 AS ABAP에 전달된다.

* ### ABAP Dispatcher

  * ABAP 로 작성된 어플리케이션의 리소스를 각 운영 체제와 연계하여 관리
  * 요청을 Work Process에 분배
  * Presentation Layer  통합
  * 통신 액티비티 정리
  * 처리 요청을 요청 queue에 저장 후 처리
    * queue는 first in first out 를 원칙으로 한다. 선입 선출 원칙

  ABAP Dispatcher가 요청을 받아 이 요청으로 work process를 할당한다.

  유저와 1대1로 section이 맺어지지 않는다. (사용자에 대한 고정 작업 프로세스가 있는 것이 아니다.) => 빈 프로세스에 넣는 방식

  따라서 특정 유저의 요청이 긴 시간을 실행하고 있으면 다른 유저의 요청을 실행 할 수 없다. (유한 자원)  => 자원 낭비 => background 워크 프로세스로 실행한다.

  Buffer 는 데이터베이스 레벨의 테이블의 데이터를 로드하여 사용할 수 있게 해준다.

  각 인스턴스에는 자체 버퍼가 존재한다.

  ![processflow](./img/processflow.png)

  작업 프로세스는 어플리케이션 프로그램의 프로세스 로직을 실행한다.

  작업 프로세스의 내부는 메인 메모리, 작업 프로세스의 동작을 조정하는 태스크 핸들러, 각종 소프트웨어 프로세서, 데이터베이스 인터페이스로 구성

  Dynpro 프로세서는 어플리케이션 프로그램의 화면 흐름 로직을 실행하고 어플리케이션 프로그램의 실질적인 처리 로직을 실행

  화면 프로세서는 화면 흐림 로직의 처리 상태에 따라 실행해야 하는 하위 프로그램을 ABAP 프로세서에 알려준다.

  디스패처가 특정 다이얼로그 작업 프로세스를 선택하면 해당 프로세스는 먼저 사용자 컨텍스트 데이터를 *<u>Roll-In</u>*  한다.

  이를 통해 실행중인 프로그램의 처리 상태와 사용자 정보가 작업 프로세스에 인식된다.

  그러면 작업 프로세스가 사용자 요청을 처리하고, 처리 결과를 반환한 다음 사용자 컨텍스트 데이터를 공유 메모리로 *<u>Roll-Out</u>* 한다.

  *<u>Roll-Out</u>*까지 마친 Work Process는 다시 요청 *Queue*에 대기 중인 새로운 사용자 요청을 처리할 수 있게 된다.

  결과가  SAP GUI에 전송되면 사용자에 새로운 화면이 표시된다. 

****

* ## AS ABAP 의 데이터베이스 인터페이스

  대규모의 데이터 집합을 관리하기 위해 RDBMS 을 사용한다.

  RDBMS는 데이터와 데이터 관계를 2차원 테이블로 저장한다.

  데이터, 테이블 및 테이블 관계는 RDBMS 데이터베이스 카탈로그(데이터 딕셔너리)의 데이터베이스 레벨에서 정의된다.

  ![flowofdb](./img/flowofdb.png)

  ABAP에서는 *<u>ABAP Open SQL</u>*을 사용하면 RDBMS 의 유형과 상관 없이 데이터베이스에 있는 어플리케이션 데이터에 액세스할 수 있다.

  AS ABAP의 모든 작업 프로세스에 포함되는 DB interface 가 ABAP의 Open SQL 문을 사용중인 데이터베이스의 해당 SQL문으로 변환해 준다.

  * ABAP Open SQL 은 (ISO) SQL 표준을 바탕으로 한 데이트베이스 쿼리 언어이다.
  * ABAP Open SQL 에는 SQL 표준에는 없는 추가 기능이 포함되어있다.

  SAP DB interface 는 Open SQL 문을 해석할 때 그 구문을 점검하여 어플리케이션 서버 공유 메모리의 로컬 SAP버퍼가 가장 효과적으로 활용되도록 한다.

  자주 사용되는 데이터는 이 버퍼에 저장되므로 시스템에서 해당 데이터를 읽기 위해 매번 데이터베이스 서버에 액세스 할 필요가 없다.

  특히, 운영체제가 변경되지 않는 한 ABAP 프로그램, 화면, ABAP 딕셔너리 정보, 작업 관리 매개변수와 같은 기술 데이터는 모두 변경 없이 그대로 유지되므로 기술 데이터는 버퍼에 저장하기에 이상적이다.

  Native SQL을 사용하기 위해서는 구문의 시작과 끝에 각각 *<u>EXEC SQL. , END EXEC.</u>* 구문을 사용해 준다.

  ABAP 인터프리터는 이 코드 안의 명령어에 대해서는 구문을 검사하지 않는다.

  * 단, Native SQL을 사용하여 프로그램을 개발하면 프로그램의 플랫폼 독립성이 사라진다. 

  * 다시 말해, 플랫폼에 따라 제약이 발생할 수 있다.

****

* ## 다이얼로그 요청 처리

  ![dialogwp](./img/dialogwp.png)

  위의 그림에서 보듯이, 프로그램의 다이얼로그 단계는 하나의 특정한 다이얼로그 작업 프로세스에 지정된다

  **여러 개의 화면으로 구성된 프로그램**의 경우에는 각 다이얼로그 단계가 프로그램 런타임 중에 **여러 다이얼로그 작업 프로세스에 의해 실행** 될 수 있다.

  이를 ***Work Process Multiplexing*** 이라고 한다.

  다이얼로그 작업 프로세스는 여러 사용자 및 프로그램의 다이얼로그 단계를 순차적으로 처리한다.

  SAP 어플리케이션은 사용자 상호작용과 처리 로직을 구분한다.

  사용자 액션은 Dynpro(dynamic program) 라고도 하느느 화면을 사용하여 기술적으로 구현되는데 이는 화면 이미지와 기반이 되는 흐름 로직으로 구성된다.

  작업 프로세스의 Dynpro 프로세서는 어플리케이션의 화면 흐름 로직을 실행하고 처리 로직 모듈을 호출하며 필드 내용을 처리 로직으로 전송한다.

  * ### 화면 흐름 로직 모듈 세분화

    * #### Process Before Output (PBO)

      * 화면 이미지를 보내기전에 처리된다.
      * 이부분은 논리적으로 후속화면 이미지에 속한다.

    * #### Process After Input (PAI)

      * 사용자가 화면에 입력을 한 후에 처리된다.
      * 이 부분은 논리적으로 이전 화면 이미지에 속한다.

  ABAP 프로그램의 실질적인 처리 로직은 ABAP 인터프리터가 실행한다.

  화면 흐름 로직의 처리 상태에 따라 실행해야 하는 하위 프로그램을 화면 프로세서가 ABAP 프로세서에 알려준다.

  다이얼로그 단계에서 데이터베이스나 버퍼와의 데이터 교환은 DB Interface를 통해 교환한다.

  이렇듯 데이터베이스 인터페이스를 거치므로 데이터베이스 테이블, ABAP 프로그램, ABAP 딕셔너리 등 다양한 대상에 액세스 할 수 있다.

****

* ## AS ABAP에서의 업데이트

  * ### 트랜잭션

    * #### 트랜잭션은 기능적으로 같은 부류에 속하는 처리단위이다.

    * #### 트랜잭션의 주요 특징 (ACID)

      * 원자성 (Atomic)

        트랜잭션이 완전하게 처리되지 않는 한 이 트랜잭션은 아무런 효과도 일으키지 않는다. 

        트랜잭션을 진행하던 시스템이 다운되면 일관성 없는 불완전한 결과는 모두 저장되지 않고 사라진다.

      * 일관성 (Consistent)

        시스템 상태가 특정 상태에서 다른 상태로 변경되려면 두 상태 모두가 정확하고 작업적으로 일관성이 있어야 한다.

      * 고립성 (Isolated)

        트랜잭션이 처리하는 변경사항은 최종 확정(커밋) 되기 전까지 다른 트랜잭션이 볼 수 없다.

      * 지속성 (Durable)

        최종 확정 후에느느 데이터베이스에 영구적으로 저장되어 트랜잭션의 결과가 지속된다.

  * ### 데이터베이스 트랜잭션과 ABAP 트랜잭션

    * 모든 작업 프로세스는 SAP 인스턴스의 런타임 기간 내내 데이터베이스 측의 특정 통신 상대에 접속한다.
    * 런타임 기간중에는 작업 프로세스 간에 통신 상대를 맞바꿀 수 없다.
    * 따라서 작업 프로세스는 하나의 데이터베이스 트랜잭션 내에서만 데이터베이스를 변경할 수 있다.

  * ###  데이터베이스 트랜잭션

    * ACID 원칙에 따르면 데이터베이스 트랜잭션은 나눌 수 없는 일련의 데이터베이스 작업이다.
    * 트랜잭션 시작과 종료 시 데이터베이스상의 데이터세트 (Dataset) 가 일관성을 유지해야한다.
    * 데이터베이스 트랜잭션의 시작과 끝은 데이터베이스 시스템에 대한 커밋 명령어로 정의된다.
    * 데이터베이스 트랜잭션을 처리하는 동안에는 데이터베이스 시스템이 직접 데이터세트의 일관성 유지를 관리한다.
    * 오류로 인해 트랜잭션이 종료되면 데이터베이스 시스템은 데이터세트를 이전 상태로 복원한다.
      * 이를 롤백이라고 한다.

  * ### 비지니스 트랜잭션

    * 비지니스 트랜잭션은 특정 기능을 수행하기 위해 여러 개의 처리 단위가 하나로 묶여진 것
    * 대표적인 예로는 ***불가분 관계에 있는 차변과 대변의 업데이트, 주문 발생에 이은 관련자재의 예약***이 있다.
    * AS ABAP 트랜잭션은 전부가 아니면 전무하게 실행되어야 하는 나눌 수 없는 비지니스 프로세스로 정의된다.
    * 시스템 상에서 AS ABAP 트랜잭션은 업무적으로 일관되고 논리적으로 연결된 연속적 다이얼로그 단계의 형태로 나타난다.
    * 하나의 화면 이미지가 하나의 사용자 다이얼 로그 단계에 해당한다.

  

  ![transactions](./img/transactions.png)

  db transaction은 화면 이동 찰나의 순간에 해당된다.



# 여기서 부터 다시!!! PG 114



![lockmanagement](./img/lockmanagement.png)

abap ms 를 통해 두 서버의 abap dispatcher를 연결해 준다.







![asynchronous](./img/asynchronous.png)

110번에서 저장 버튼을 누를때 commit work가 이루어 져야 한다.

따라서 나머지의 구간에서는 flag만 바꿔준다.

즉 일부 transaction의 수정 내용만이 따로 저장되진 않는다.

이런 과정을 all or nothing이라고 한다.



![asynchronous1](./img/asynchronous1.png)

call function ... in update task 구문은 commit work 구문을 만나야지만 dispatcher는 update work proccess를 할당한다.



****

****



## Lesson4. Using additional Processes of an AS ABAP System

![printing](./img/printing.png)





![background](./img/background.png)

특정 프로그램을 주기적으로 정해진 룰에 따라 실행해야 되는 경우

또는 실행 기간이 긴 프로그램을 실행

scheduling을 설정해 놓으면 ABAP dispatcher는 scheduling을 참고 하여 background wp를 할당하여  실행한다



![gw](./img/gw.png)

gw는 주로 별도의 시스템을 연결하는데 사용한다.

gw는 ms처럼 dispatcher들을 연결 할 수 있으나 주로 사용하지 않는다.





![webrequest](./img/webrequest.png)











![](./img/)