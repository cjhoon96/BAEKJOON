# 1장 노드 시작하기

****



# 1.1 핵심 개념 이해하기

****



## NODE.JS 란 무엇인가?

* NODE.JS 는 CHROME V8 JAVASCRIPT 엔진으로 빌드된 JAVASCRIPT 런타임이다.

* NODE는 서버만을 실행 할 수 있는 것이 아니라 자바스크립트  프로그램을 실행 하는 런타임으로서 사용하기도 한다.
* 노드는 자바 어플리케이션을 실행하는데 제일 많이 사용한다.



## 서버란?

네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램을 말한다.

* ### 클라이언트란?

  요청을 보내는 주체로 브라우저 / 데스크톱 프로그램 / 모바일 앱 / 다른 서버에 요청을 보내는 서버  가 클라이언트일 수 있다. 

웹이나 앱을 사용할 때 데이터(아이디, 비밀번호, 이메일 등) 와 서비스의 데이터가 생성 된다. 

이 데이터를 어딘가에 저장하고, 그 어딘가에서 클라이언트로 데이터를 받아와야 한다. 이 역할을 하는 곳이 서버이다.

서버는 요청에 대한 응답만 하는 것이 아니라 다른 서버에 요청을 보낼 수도 있다. 이때는 요청을 보내는 서버가 클라이언트의 역할을 한다.

노드는 자바스크립트 프로그램이 서버로서 기능하기 위한 도구를 제공하므로 서버의 역할을 수행항 룻 있다.

그렇다면 왜? 굳이 노드를 사용해 서버를 만드는가?



## 자바스크립트 런타임

* ### 런타임이란?

  특정 언어로 만든 프로그램을 실행할 수 있는 환경

기존에는 자바스크립트 프로그램을 웹 브라우저 위에서만 실행할 수 있었다. 브라우저는 자바스크립트 런타임을 내장하고 있으므로 자바스크립트 코드를 실행 할 수 있다.

브라우저 외의 환경에서 자바스크립트를 실행하기 위한 여러 시도가 있었으나 실행 속도 문제로 큰 호응을 얻지는 못했다.

V8 엔진으로 속도 문제가 해결되자 V8 엔진 기반의 노드 프로젝트를 시작

노드는 V8과 LIBUV 라는 라이브러리를 사용한다. 둘은 C와 C++ 로 구현되어있다.

LIBUV 라이브러리는 노드의 특성인 **<u>이벤트 기반</u>** / **<u>논 블로킹 I/O</u>** 모델을 구현하고 있다.



## 이벤트 기반

이벤트 기반이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 의미한다. 

특정 이벤트가 발생할 때 수행할 것을 등록해 두어야 하는데 이를 **<u>이벤트 리스터에 콜백 함수를 등록</u>** 한다고 표현한다.

이벤트 기반 모델에서는 **이벤트 루프** 라는 개념이 등장한다.

* ### 이벤트 루프

  아벤트 발생시 호출할 콜백 함수들을 관리, 실행 순서를 결정하는 역할

  노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복 하므로 루프라고 부른다.

* ### 백그라운드

  setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳

  * setTimeout 같은 경우 호출 스택에 함수들이 너무 많이 들어있는 경우 정해진 시간이 지난 후에도 실행되지 않을 수 있다.

    이벤트 루프는 호출 스택이 비어있는 경우에만 태스크 큐에 있는 run 함수를 호출 스택으로 가져오기 때문

    따라서 setTimeout 은 정확성이 떨어진다.

  자바스크립트가 아닌 다른 언어로 작성된 프로그램이라고 봐도 된다.

  여러 작업이 동시에 실행될 수 있다.

* ### 태스크 큐

  이벤트 발생 후, 백그라운드에서는 태스크 큐로 타이머나 이벤트 리스너의 콜백 함수로 보낸다. 

  콜백 큐라고도 부른다.

  보통 완료된 순서대로 줄 서 있지만 특정한 경우 순서가 바뀌기도 한다.

  

## 논 블로킹 I/O

이벤트 루프를 잘 활용하면 오래 걸리는 작업을 효율적으로 처리할 수 있다.

작업에는 두가지 종류가 있는데 동시에 실행될 수 있는 작업과 동시 실행이 불가능한 작업이다.

기본적으로 작성할 자바스크립트 코드는 동시에 실행될 수 없다. 

하지만 자바스크립트 상에서 돌아가는 것이 아닌 **I/O 작업** 같은 것은 동시에 처리될 수 있다.

I/O 는 Input / Output 을 의미한다. 파일 시스템 접근 (파일 읽기 / 파일 쓰기 / 폴더 만들기) 등이나 네트워크를 통한 요청 같은 작업이 I/O 의 일종이다.

이러한 작업을 할 때 노드는 논 블로킹 방식으로 처리하는 방법을 제공한다. 

* ### 논 블로킹이란?

  이전 작업이 완료될 때 까지 대기 하지 않고 다음 작업을 수행함을 뜻한다. 

  반대로 블로킹은 이전 작업이 끝나야만 다음 작업을 수행하는 것을 의미한다.

노드는 I/O 작업을  백그라운드로 넘겨 동시에 처리하곤 한다. 따라서 동시에 처리될 수 있는 작업들은 최대한 묶어서 백그라운드로 넘겨야 시간을 절약할 수 있다.

따라서 동시에 처리될 수 있는 I/O 작업이라도 논 블로킹 방식으로 코딩하지 않으면 의미가 퇴색되므로 논 블로킹 방식으로 코딩하는 습관을 들여야 한다.

**setTimeout(Callback , 0)** 은 코드를 논 블로킹으로 만들기 위해 사용하는 기법중 하나이다.

* ### setTimeout(Callback , 0)

  밀리초가 0으로 설정 되었으므로 바로 실행되는 것으로 착각할 수 있으나 브라우저와 노드에서는 기본적인 지연 시간이 있으므로 바로 실행되지 않는다. HTML5 브라우저에서는 4ms, 노드에서는 1ms 지연 시간이 있다.

하지만 노드에서는 setTimeout(Callback , 0) 보다 setImmediate 를 주로 사용한다.

이벤트 루프를 이해했다면 setTimeout 의 콜백함수가 태스크 큐로 보내지므로 순서대로 실행되지 않는다는 것을 알 수 있다.

다음 작업이 먼저 실행된 후 오래 걸리는 작업이 완료된다.

아무리 논 블로킹 방식으로 코드를 작성하더라도 위 방식으로는 전체 소요 시간이 짧아지지는 않는다. 단지 순서가 바뀔뿐 서로 동시에 실행되지 않기 때문이다.

그렇다고 I/O 작업이 없다고 논 블로킹이 의미가 없는 것이 아니다. 오래 걸리는 작업을 처리해야하는 경우, 논 블로킹을 통해 실행 순서를 바꿔줌으로써 그 작업 때문에 간단한 작업들이 대기하는 상황을 막을 수 있다는 점에서 의의가 있다. 

또한 **<u>논 블로킹과 동시가 같은 의미가 아니라는</u>** 것도 알아두어야한다.

동시성은 **<u>동시 처리가 가능한 작업을 논 블로킹 처리해야</u>** 얻을 수 있다.

블로킹 / 논 블로킹 외에 동기 / 비동기 의 개념은 이후 3.6.1 에서 다루게 된다.



## 싱글 스레드 

싱글 스레드란 스레드가 하나뿐 이라는 것을 의미한다.

일반적인 자바스크립트 코드가 동시에 실행될 수 없는 이유이기도 하다.

스레드를 이해하기 위해서는 프로세스부터 알아야한다.

* ### 프로세스와 스레드의 차이

  * 프로세스는 운영체제에서 할당하는 작업의 단위이다.
  * 노드나 웹브라우저 같은 프로그램은 개별적인 프로세스이다.
  * 프로세스간에는 메모리 등의 자원을 공유하지 않는다.
  * 스레드는 프로세스 내에서 실행되는 흐름의 단위이다.
  * 프로세스는 스레드를 여러개 생성해 여러 작업을 동시에 처리할 수 있다.
  * 스레드들은 부모 프로세스의 자원을 공유한다.
  * 같은 주소의 메모리에 접근 가능하므로 데이터를 공유할 수 있다.

노드는 엄밀히 말하면 싱글 스레드로 동작하지는 않는다. 

노드를 실행하면 먼저  프로세스가 하나 생성된다. 그리고 그 프로세스에서 스레드들을 생성하는데 이때 내부적으로 스레드를 여러개 생성한다. 

그중에서 직접 제어할 수 있는 스레드는 하나뿐이다. 이것이 노드가 싱글 스레드라 여겨지는 이유이다.

스레드를 작업을 처리하는 일손으로 표현하기도 하는데 하나의 스레드만 직접 조작할 수 있으므로 일손이 하나인 셈

요청이 많이 들어오면 한번에 하나씩 요청을 처리한다.

블로킹이 심하게 일어나는 작업을 처리하지만 않는다면 스레드 하나로도 충분

블로킹이 발생할 것 같은 경우에는 논 블로킹 방법으로 대기 시간을 최대한 줄인다.

노드가 싱글 스레드로 동작하지 않는 두 가지 경우가 있다. 

하나는 스레드풀(Thread Pool) 이고 다른 하나는 워커 스레드(Worker Thread) 이다.

* ### 스레드 풀(Thread Pool) 

  스레드풀은 노드가 특정 동작을 수행할 때 스스로 멀티 스레드를 사용한다.

  대표적인 예로 암호화 / 파일 입출력 / 압축 등이 있다.

* ### 워커 스레드(Worker Thread)

  워커 스레드는 노드 12 버전에서 안정화된 기능으로 이제 노드에서도 멀티 스레드를 사용할 수 있게 되었다.

  직접 다수의 스레드를 다룰 수 있다. 

  CPU 작업(연산이 많은 작업) 이 많은 경우 워커 스레드를 사용하면 된다.

언뜻 보면 여러 개의 일을 동시에 처리할 수 있는 멀티 스레드가 싱글 스레드보다 좋아 보인다. 장단점이 있다.

| 멀티 스레딩                                 | 멀티 프로세싱            |
| ------------------------------------------- | ------------------------ |
| 하나의 프로세스 안에서 여러개의 스레드 사용 | 여러 개의 프로세스 사용  |
| CPU 작업이 많을 때 사용                     | I/O 요청이 많을 때 사용  |
| 프로그래밍이 어려움                         | 프로그래밍이 비교적 쉬움 |



****

# 1.2 서버로서의 노드

****



노드는 기본적으로 싱글 스레드, 논 블로킹 모델을 사용하므로 (자바스크립트 언어의 특성이기도 하다)

노드 서버 또한 동일한 모델이다.

서버에서는 기본적으로 I/O 요청이 많이 발생한다. 

노드는 LIBUV 라이브러리를 사용해 I/O 작업을 논 블로킹 방식으로 처리한다. 따라서 스레드 하나가 많은 수의 I/O 를 혼자서도 감당할 수 있다.

하지만 노드는 CPU 부하가 큰 작업에는 적합하지 않다. 

개수는 많지만 크기는 작은 데이터를 실시간으로 주고받는 잡업에 적합하다.

네트워크나 데이터베이스 디스크 작업 같은 I/O 에 특화되어있기 때문

실시간 채팅 애플리케이션이나 주식 차트, JSON 데이터를 제공하는 API 서버가 노드를 많이 사용한다.

노드 12 버전에서 워커 스레드 기능이 안정화 되었지만 멀티 스레드 프로그래밍을 하는 것은 싱글 스레드에 비해 어렵다. 스레드가 작업을 나눠서 처리할 수 있게 직접 나누어 주는 것이 그렇다.

또한 멀티 스레드 프로그래밍 하더라도 C / C++ / RUST / GO 와 같은 언어에 비해 속도가 많이 느리다.

따라서 멀티 스레드 기능이 있다고 해도 이미지, 비디오처리 / 대규모 데이터 처리 처럼 CPU 를 많이 사용하는 작업을 위한 서버로는 권장하지 않는다. 노드보다 더 적합한 다른 언어 서버가 많다. 

그럼에도 굳이 노드로 하고 싶다면 AWS 람다 나 구그글 클라우드 펑션스 같은 서비스에서 노드로 CPU 를 많이 사용하는 작업을 처리하는 것을 지원하므로 고려해봐야한다.

싱글 스레드 방식으로 서버를 운영할 때는 하나뿐인 스레드가 에러로 인해 멈추지 않도록 잘 관리해야한다.

노드는 내장된 웹 서버가 있어 편리하다. 규모가 커지는 경우 결국 NGINX 등의 웹 서버를 노드 서버와 연결해야한다.



* ### 노드의 장단점

  | 장점                                          | 단점                                              |
  | --------------------------------------------- | ------------------------------------------------- |
  | 멀티 스레드 방식에 비해 적은 컴퓨터 자원 사용 | 기본적으로 싱글 스레드라서 CPU 코어를 하나만 사용 |
  | I/O 작업이 많은 서버로 적합                   | CPU 작업이 많은 서버로는 부적합                   |
  | 멀티 스레드 방식보다 쉬움                     | 하나뿐인 스레드가 멈추지 않도록 관리가 필요       |
  | 웹서버가 내장되어있음                         | 규모가 커졌을 때 서버를 관리하기 어려움           |
  | 자바스크립트를 사용                           | 어중간한 성능                                     |
  | JSON 형식과 쉬운 호환                         |                                                   |

  



****

# 1.3 서버 외의 노드

****



처음에는 노드를 대부분 서버로 사용하였지만 용도가 서버에만 한정되지 않는다. 

사용 범위가 점점 늘어나 웹 / 모바일 / 데스크톱 애플리케이션 개발에도 사용되기 시작했다.

노드 기반으로 돌아가는 대표적인 웹 프레임워크는 앵귤러 / 리액트 / 뷰 등이 있다.

앵귤러는 구글 진영에서 프런트 엔드 앱을 만들 때 주로 사용하고, 리액트는 페이스 북 진영에서 주로 사용한다.

모바일 개발 도구로는 리액트 네이티브 를 많이 사용한다. 

페이스북, 인스타그램, 핀터레스트, 월마트, 테슬라 등이 리액트 네이티브를 사용하여 모바일 앱을 운영 중이다.

데스크톱 개발 도구로는 일렉트론 이 대표적이다. (ATOM / SLACK / DISCORD / VSCODE)



****

# 1.4 개발 환경 설정

****

.........